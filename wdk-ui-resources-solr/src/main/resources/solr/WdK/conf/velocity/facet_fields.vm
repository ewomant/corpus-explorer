#**
 *  Display facets based on field values
 *  e.g.: fields specified by &facet.field=
 *#
#set($term_clouds_activated = false)

#if($response.facetFields)

  #*
  <h2 #annTitle("Facets generated by adding &facet.field= to the request")>
    Field Facets
  </h2>
  *#
  #foreach($field in $response.facetFields)
      #set($field_active = false)



     #foreach($sq_fieldname in $selected_filter_queries.keySet())
       ##  $selected_filter_queries[$sq_fieldname]

       #if($sq_fieldname.contains($field.name))
           #set($field_active = true)
       #end
       ##extract facet-values -> hashmap
      #end

      ##http://localhost:8983/solr/WdK.dev/browse?&fq={!tag%3DInhalt_Raum_Thema_wdk}(Inhalt_Raum_Thema_wdk%3A%22Deutsche+Geschichte%22+OR+%22Weltgeschichte%22)
    #if($field.name == "text")
        #set($term_clouds_activated = true)
    #end

    ## Hide facets without value
    #if($field.values.size() > 0)

	  <h2  id="facetbox_${field.name}"  class="facet-field#if($field_active) facet-field_active#end" title="$!facet_descriptions[${field.name}]">#displayfacetname($field.name)
          </h2>

            <ul class="collapsible facet-field">

            ##add single-value option
                #if($add_facet_unique_option.contains($field.name) && ! ($selected_filter_queries[$field.name]['value'].size() >1) ) ##todo multiselect: and not values.size >1
                    <li class="facetoption">
                    #set($nUniqueFacet = "${field.name}${unique_option_suffix}")

                    #if($selected_filter_queries[$nUniqueFacet])

                        <a class="pure-button pure-button-active checkbuttonactive sl" href="#{url_for_filters_no_current}( $nUniqueFacet)">Eindeutiger Wert</a>
                    #else

                        <a class="pure-button checkbutton sl" href="#url_for_facet_filter2($nUniqueFacet, 1)">Eindeutiger Wert</a>
                    #end
                    </li>
                #end

                #if($field_active)
                    <li class="facetoption"><a  class="pure-button sl" href="#{url_for_filters_no_current}( $field.name)"/>Alle abw&auml;hlen</a>
                    </li>
                #end

        #foreach($facet in $field.values)

            #set($value_active = false)
            #set($values_no_current = [])
            #set($values_with_current = [])

            #if(!$facet.name)

                #set($facet_name = $missing_value)
            #else
                #set($facet_name = $facet.name.trim().replaceAll('"', ''))
            #end

            #foreach($selected_value in $selected_filter_queries[$field.name]['value'])

                #if($selected_value == $facet_name && $field_active)
                    #set($value_active = true)

                #else
                    #set($success =  $values_no_current.add($selected_value))
                    #set($success =  $values_with_current.add($selected_value))

                #end


            #end



            #set($success =  $values_with_current.add($facet_name))



            ##Adding unique-option to link only if not more than one value is selected
            #set($fq_unique_option = "" )
            #if($add_facet_unique_option.contains($field.name) && $selected_filter_queries[$nUniqueFacet] && ($values_with_current.size() == 1))
                #set($fq_unique_option = "&fq=#createFQ_noQ_noTag(${nUniqueFacet}, 1)")
            #end


            #if($facet.count > 0 ||  $value_active ) ##hide empty cells, but only if not currently selected

            <li class="facet#{if}($value_active) facet_selected#{end}">
            #if(!$field_active)    ##do not show facetbar for facets with selected values
                #facetbar($facet.count)
            #end



                #if( $field_active && $value_active  )
                    ##using $values_no_current
                    <a href='#url_for_facet_filter_multi($field.name, $values_no_current)$fq_unique_option' class="multi_facet_field multi_facet_field_selected sl">#facetname($facet_name )#relative_results($facet.count)</a>
                 #else
                    ## using $values_with_current
                <a href="#url_for_facet_filter_multi($field.name, $values_with_current)$fq_unique_option" class="multi_facet_field sl">#facetname($facet_name )#relative_results($facet.count)</a>
                #end


          ##TODO: on hover add option to add + facet for field to query instead of replacing it




            </li>
            #end
        #end
            </ul>

        #if(false)##if($field.name == 'text')
        <h2  id="wordcloudbox_${field.name}"  class="facet-field">Wordcloud #displayfacetname($field.name)</h2>
        <div class="collapsible" id="wordcloud_$field.name">  </div>
        <script>var words = [
                #foreach($facet in $field.values)#if($velocityCount>1),#end {"text": "$facet.name", "size" : $facet.count}
                #end
        ];
            jQuery(document).ready(function(){
                createWordCloud("$field.name", words);
            });
        </script>

       #end ##end wordcloud

    #end  ## end if > 0
  #end    ## end for each facet field
#end      ## end if response has facet fields

#if($term_clouds_activated)

<a class="additionalfacettoggle  pure-button pure-button-active sl" href="#url_for_home#{lens_without_P}(['facet.field', 'textfs', "f.namedentities_per.facet.limit", "f.namedentities_loc.facet.limit", "f.text.facet.limit"])">Text- und Namensfacetten aktiv</a>

    <div id="termnumberselector">
        Anzeigen:


        #foreach($termnumber in $termnumbers)
            #if($request.params.get('f.namedentities_per.facet.limit') == $termnumber)
                <a class="pure-button button-xsmall pure-button-active sl" href="#url_for_home#{lens_without_P}(['facet.field', 'textfs', "f.namedentities_per.facet.limit", "f.namedentities_loc.facet.limit", "f.text.facet.limit"])">$termnumber</a>
                #else
            <a class="pure-button button-xsmall sl"  href="#url_for_home#{lens_without_P}($termfacets)#foreach( $termfacet in $termfacets)&$termfacet=$termnumber#end">$termnumber</a>

            #end
        #end

    </div>

 #else
<a class="additionalfacettoggle  pure-button sl" href="#url_for_home#{lens_without_P}(['facet.field'])#foreach($f in $text_facets)&facet.field=$esc.url("{!ex=$f}")$f#end&textfs=true">Filter f&uuml;r h&auml;ufige Terme und Namen aktivieren</a>
#end
