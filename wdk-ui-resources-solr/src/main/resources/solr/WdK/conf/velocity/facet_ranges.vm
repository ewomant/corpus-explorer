#**
 *  Display facets based on ranges of values, AKA "Bukets"
 *  e.g.: ranges specified by &facet.range=
 *#

#*
<h2 #annTitle("Facets generated by adding &facet.range= to the request")>
  Range Facets
</h2>
*#

#foreach ($field in $response.response.facet_counts.facet_ranges)

  ## Hide facets without value
  #if($field.value.counts.size() > 0)
	#set($name = $field.key)
	#set($display = $name)
	#set($f = $field.value.counts)
	#set($start = $field.value.start)
	#set($end = $field.value.end)
	#set($gap = $field.value.gap)
	#set($before = $field.value.before)
	#set($after = $field.value.after)
	#set($between = $field.value.between)

     ## #if(1)
	        #display_facet_range_year($f, $display, $name, $start, $end, $gap, $before, $after, $between)
      ##else
           ## #display_facet_range($f, $display, $name, $start, $end, $gap, $before, $after, $between)
      ##end
  #end  ## end if has any values
#end    ## end for each facet range



#macro(display_facet_range_year $field, $display, $fieldName, $start, $end, $gap, $before, $after, $between)
    #set($field_active = false)

    #if($selected_filter_queries[$fieldName])
        #set($field_active = true)
    #end

<h2  id="facetbox_${fieldName}" title="$!facet_descriptions[${fieldName}]" class="facet-field#if($field_active) facet-field_active#end" > #displayfacetname($display)</h2>

    #set($fromto = ["-1","$start","$end"])


    #if ($selected_filter_queries[$fieldName])
            #set($fromto_string = $selected_filter_queries[$fieldName].value)

            #set($fromto = $fromto_string.split("\[|\sTO\s|\]"))

            #if($fromto[1] && $fromto[1] == "*")
                #set($fromto[1] = "0")
            #end
    #end

<ul class="collapsible">

    <li><form class="customyear pure-form" action="#url_for_filters_no_current(${fieldName})" method="get">
        <input type="number" size="4" value="$!fromto[1].trim()" min="1700" max="1930" class="RangeYearFrom" name="RangeYearFrom"> :
        <input type="number" size="4" value="$!fromto[2].trim()" min="1700" max="1930" class="RangeYearTo" name="RangeYearTo">
        <input type="hidden" class="RangeYearUrl" value="#url_for_filters_no_current(${fieldName})"/>
        <input type="hidden" class="timefield" value="${fieldName}"/>
        <input type="submit" class="sortSubmit pure-button" value="OK"/>

    </form></li>

    #foreach ($facet in $field)
        #set($rangeEnd = "#range_get_to_value_year($facet.key, $gap)")
        #set($value = "[" + $facet.key.trim() + " TO " + $rangeEnd.trim() + "]")
        #set($facetURL = "#url_for_facet_range_filter2($fieldName, $value)")
        #if ($facetURL != '')

            <li class="facet facet-range">

                #if(!$field_active)#facetbar($facet.value)#end


                #if($field_active && $selected_filter_queries[$fieldName]['value'] == $value)

                    <a class="selected sl" href="#url_for_filters_no_current($fieldName)">#facetname("$facet.key - #format_value($rangeEnd)")#relative_results($facet.value)</a>
                    #else
                        <a class="sl" href="$facetURL">#facetname("$facet.key - #format_value($rangeEnd)")#relative_results($facet.value)</a>
                #end
            </li>
        #end
    #end

    #if($before && $before != "" && $before >0)
        #set($value = "[* TO " + "#format_value($start)" + "]")
        #set($facetURL = "#url_for_facet_range_filter2($fieldName, $value)")

        <li class="before facet facet-range">
            #if(!$field_active)#facetbar($before)#end
            #if($field_active && $selected_filter_queries[$fieldName]['value'] == $value)
                <a class="selected sl" href="#url_for_filters_no_current($fieldName)">#facetname("Vor #format_value($start)")#relative_results($before)</a>
            #else
                <a class="sl" href="$facetURL">#facetname("Vor #format_value($start)")#relative_results($before)</a> </li>
            #end

    #end
    #if($between && $between != "" && $between > 0)
        #set($value = "[" + "#format_value($start)" + " TO " + "#format_value($end)" +  "]")
        #set($facetURL = "#url_for_facet_range_filter2($fieldName, $value)")
        <li class="between facet facet-range">
            #if(!$field_active)#facetbar($between)#end

            #if($field_active && $selected_filter_queries[$fieldName]['value'] == $value)
                <a class="selected sl" href="#url_for_filters_no_current($fieldName)">#facetname("Von #format_value($start) bis #format_value($end)")#relative_results($between)</a>
            #else
                <a class="sl" href="$facetURL">#facetname("Von #format_value($start) bis #format_value($end)")#relative_results($between)</a>
            #end
        </li>
    #end
    #if($end && $end != "" && $after > 0)
        #set($value = "[" + "#format_value($end)" + " TO *]")
        #set($facetURL = "#{url_for_facet_range_filter2}()$fieldName, $value)")

        <li class="after facet facet-range">
            #if(!$field_active)#facetbar($after)#end

            #if($field_active && $selected_filter_queries[$fieldName]['value'] == $value)
                <a class="selected sl" href="#url_for_filters_no_current($fieldName)">#facetname("Nach #format_value($end)") #relative_results($after)</a>
            #else
                <a class="sl" href="$facetURL">#facetname("Nach #format_value($end)") #relative_results($after)</a>
            #end


        </li>
    #end



</ul>
#end



#macro(display_facet_range $field, $display, $fieldName, $start, $end, $gap, $before, $after)
<h2  id="facetbox_${fieldName}" class="facet-field"> #displayfacetname($display)</h2>
<ul  class="collapsible">
    #if($before && $before != "")
        #set($value = "[* TO " + "#format_value($start)" + "}")
        #set($facetURL = "#url_for_facet_range_filter($fieldName, $value)")
        <li><a class="sl" href="$facetURL">Less than #format_value($start)</a> ($before)</li>
    #end
    #foreach ($facet in $field)
        #set($rangeEnd = "#range_get_to_value($facet.key, $gap)")
        #set($value = "[" + $facet.key + " TO " + $rangeEnd + "}")
        #set($facetURL = "#url_for_facet_range_filter($fieldName, $value)")
        #if ($facetURL != '')
            <li><a class="sl" href="$facetURL">$facet.key - #format_value($rangeEnd)</a> ($facet.value)</li>
        #end
    #end
    #if($end && $end != "" && $after > 0)
        #set($value = "[" + "#format_value($end)" + " TO *}")
        #set($facetURL = "#url_for_facet_range_filter($fieldName, $value)")
        <li><a class="sl" href="$facetURL">More than #format_value($end)</a> ($after)</li>
    #end
</ul>
#end

